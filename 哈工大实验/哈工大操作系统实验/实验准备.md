# 实验准备

**将gcc3.4和hit-oslab上传到Linux**

上传到Linux是因为我们的hit-oslab集成实验环境是基于Linux操作系统的。

**安装gcc**

```shell
 tar -zxvf gcc-3.4.tar.gz
```

进入目录

```shell
cd gcc-3.4
```

可以看到有两个目录：amd64，i386，amd64目录下存放的是64位操作系统安装gcc3.4的包，i386目录存放的是32位操作系统安装gcc3.4的包

```shell
cd amd64			#进入目录
sudo dpkg -i *.deb	#安装所有包
gcc-3.4 -v 			#查看是否安装成功
```

**编译环境**

```shell
apt-cache search as86 ld86

sudo apt-get install bin86				#安装bin86
sudo apt-get install libc6-dev-i386 	#安装32位系统的兼容库
```

**安装运行环境**

```shell
sudo apt-get install libsm6:i386
sudo apt-get install libx11-6:i386
sudo apt-get install libxpm4:i386
```

**Bochs**

Bochs是一个免费且开放源代码的 IA-32（x86）架构 PC 机模拟器。在它模拟出的环境中可以运行 Linux、DOS 和各种版本的 Windows 等多种操作系统。Bochs 有虚拟机无可比拟的调试操作系统的能力，所以我们更建议您选用 Bochs。hit-oslab 已经内置了 bochs。

我们对Bochs的虚拟软驱和虚拟硬盘进行挂载就能够起到模拟操作系统的作用，Bochs的PC机模拟器上运行我们的操作系统。

**hit-oslab实验环境**

```shell
tar -zxvf hit-oslab-linux-20110823.tar.gz
```

解压之后可以看到目录结构如下

![屏幕截图 2022-05-15 224320](C:\Users\可燃冰\Desktop\编程笔记\哈工大操作系统实验\images\屏幕截图 2022-05-15 224320.png)

- bochs 目录

bochs 目录下是与 bochs 相关的执行文件、数据文件和配置文件。

- run 脚本

run 是运行 bochs 的脚本命令。

运行后 bochs 会自动在它的虚拟软驱 A 和虚拟硬盘上各挂载一个镜像文件，软驱上挂载是 **linux-0.11/Image**，硬盘上挂载的是 **hdc-0.11.img**。

因为 bochs 配置文件中的设置是从软驱 A 启动，所以 Linux 0.11 会被自动加载。

而 Linux 0.11 会驱动硬盘，并 mount 硬盘上的文件系统，也就是**将 hdc-0.11.img 内镜像的文件系统挂载到 0.11 系统内的根目录 —— `/`**。在 0.11 下访问文件系统，访问的就是 hdc-0.11.img 文件内虚拟的文件系统。

- hdc-0.11.img 文件

hdc-0.11.img 文件的格式是 Minix 文件系统的镜像。

Linux 所有版本都支持这种格式的文件系统，所以可以直接在宿主 Linux 上通过 mount 命令访问此文件内的文件，达到宿主系统和 bochs 内运行的 Linux 0.11 之间交换文件的效果。

hdc-0.11.img 内包含有：

- Bash shell；
- 一些基本的 Linux 命令、工具，比如 cp、rm、mv、tar；
- vi 编辑器；
- gcc 1.4 编译器，可用来编译标准 C 程序；
- as86 和 ld86；
- Linux 0.11 的源代码，可在 0.11 下编译，然后覆盖现有的二进制内核。

**Img文件**

oslab 工作在一个宿主操作系统之上，我们使用的 Linux，在宿主操作系统之上完成对 Linux 0.11 的开发、修改和编译之后，在 linux-0.11 目录下会生产一个名为 **Image** 的文件，它就是编译之后的目标文件。

该文件内已经包含引导和所有内核的二进制代码。如果拿来一张软盘，从它的 0 扇区开始，逐字节写入 Image 文件的内容，就可以用这张软盘启动一台真正的计算机，并进入 Linux 0.11 内核。

**编译内核**

进入linux-0.11目录，然后执行make命令

```shell
make all
```

最后生成的目标文件是一个软盘镜像文件—— `linux-0.11/Image`（下面的图中给出了详细的信息）。如果将此镜像文件写到一张 1.44MB 的软盘上，就可以启动一台真正的计算机。

linux-0.11 目录下是全部的源代码，很多实验内容都是要靠修改这些代码来完成。修改后需要重新编译内核，还是执行命令：`make all`。

**运行**

在 Bochs 中运行最新编译好的内核很简单，在 oslab 目录下执行：

```shell
./run
```

**文件交换**

oslab 下的 `hdc-0.11-new.img` 是 0.11 内核启动后的根文件系统镜像文件，相当于在 bochs 虚拟机里装载的硬盘。在 Ubuntu 上访问其内容的方法是：

```bash
$ cd ~/oslab/

# 启动挂载脚本
$ sudo ./mount-hdc
```

之后，hdc 目录下就是和 0.11 内核一模一样的文件系统了，可以读写任何文件（可能有些文件要用 sudo 才能访问）。

```bash
# 进入挂载到 Ubuntu 上的目录
$ cd ~/oslab/hdc

# 查看内容
$ ls -al
```

读写完毕，不要忘了卸载这个文件系统：

```bash
$ cd ~/oslab/

# 卸载
$ sudo umount hdc
```